{%- assign taxonomy_schema = site.data.taxonomy.taxonomy_schema -%}
{%- assign type = include.type | default: 'categories' -%}
{%- assign lang = include.lang | default: page.lang | default: 'ja' -%}
{%- assign data = site.data.taxonomy[type][lang] -%}
{%- assign counts = site.data["generated_" | append: type | append: "_counts"][lang] -%}
{%- assign ui = site.data.lang.taxonomy_ui -%}

{# 新しく追加する変数 #}
{%- assign seen_slugs = "" | split: "" -%}
{%- assign warnings_data = site.data.lang.taxonomy_warning -%} {# 警告メッセージ用のデータ #}

<h1>{{ ui.title[type][lang] }}</h1>

<div>
  <input type="text" id="filter" placeholder="{{ ui.search_placeholder[lang] }}">
  <select id="sort">
    <option value="count">{{ ui.sort_options.count[lang] }}</option>
    <option value="name">{{ ui.sort_options.name[lang] }}</option>
  </select>
</div>

{%- for group_name in data %}
  {%- assign group = group_name[1] %}
  <section>
    <h2>{{ group_name[0] }}</h2>
    <ul class="space-y-2">
      {%- assign items = group.items | sort: 'taxonomy_priority' %}
      {%- for item in items %}
        {# 各itemの警告メッセージをここで生成 #}
        {%- assign current_item_warning = "" -%}
        {%- assign current_item_name = item.taxonomy_name | default: '無名' -%}
        {%- assign current_item_slug = item.taxonomy_slug | default: '' -%}

        {%- if current_item_name == '' %}
          {% assign current_item_warning = current_item_warning | append: "⚠️ " | append: warnings_data.name_missing[lang] | append: " " %}
        {%- endif %}
        {%- if current_item_slug == '' %}
          {% assign current_item_warning = current_item_warning | append: "⚠️ " | append: warnings_data.slug_missing[lang] | append: " " %}
        {%- endif %}
        {%- if seen_slugs contains current_item_slug and current_item_slug != '' %} {# スラッグが空の場合は重複チェックから除外 #}
          {% assign current_item_warning = current_item_warning | append: "⚠️ " | append: warnings_data.slug_duplicate[lang] | append: " " %}
        {%- else %}
          {%- if current_item_slug != '' %}{% assign seen_slugs = seen_slugs | push: current_item_slug %}{% endif -%}
        {%- endif %}

        {# taxonomy-list-block.html を呼び出す際に render_type='html' を渡す #}
        {% include taxonomy-list-block.html
          item=item
          base_path="/" | append: lang | append: "/" | append: type
          counts=counts
          ui=ui
          warning=current_item_warning
          lang=lang
          render_type='html' {# render_type を明示 #}
        %}
      {%- endfor %}
    </ul>
  </section>
{%- endfor %}
