{%- assign schema = site.data.taxonomy.taxonomy_schema -%} {# ここを修正 #}
{%- assign type = include.type | default: 'categories' -%} {# 'categories' or 'tags' #}
{%- assign lang = include.lang | default: page.lang | default: 'ja' -%}
{%- assign ui = site.data.lang.taxonomy_ui -%}
{%- assign warnings_data = site.data.lang.taxonomy_warning -%}

{# データ読み込み: _data/taxonomy/categories.yml や _data/taxonomy/tags.yml を直接読み込む #}
{%- assign data = site.data.taxonomy[type] -%} {# site.data.taxonomy.categories または site.data.taxonomy.tags #}

{# 投稿記事のカウントデータは、これまで通り generated_categories_counts[lang] の形式を想定 #}
{%- assign counts = site.data["generated_" | append: type | append: "_counts"][lang] -%}


{# 新しく追加する変数 #}
{%- assign seen_slugs = "" | split: "" -%}

<h1>{{ ui.title[type][lang] }}</h1>

<div>
  <input type="text" id="filter" placeholder="{{ ui.search_placeholder[lang] }}">
  <select id="sort">
    <option value="count">{{ ui.sort_options.count[lang] }}</option>
    <option value="name">{{ ui.sort_options.name[lang] }}</option>
  </select>
</div>

<section>
  <h2>{{ ui.all_categories_or_tags[lang] }}</h2>
  <ul class="space-y-2">
    {%- assign items = data | sort: 'taxonomy_priority' %} {# dataは直接カテゴリのリストになっているはず #}
    {%- for item in items %}
      {# 各itemの警告メッセージをここで生成 #}
      {%- assign current_item_warning = "" -%}
      {# taxonomy_name は多言語キーを持つので、[lang] でアクセス #}
      {%- assign current_item_name = item.taxonomy_name[lang] | default: '無名' -%}
      {%- assign current_item_slug = item.taxonomy_slug | default: '' -%}

      {%- if current_item_name == '' %}
        {% assign current_item_warning = current_item_warning | append: "⚠️ " | append: warnings_data.name_missing[lang] | append: " " %}
      {%- endif %}
      {%- if current_item_slug == '' %}
        {% assign current_item_warning = current_item_warning | append: "⚠️ " | append: warnings_data.slug_missing[lang] | append: " " %}
      {%- endif %}
      {%- if seen_slugs contains current_item_slug and current_item_slug != '' %}
        {% assign current_item_warning = current_item_warning | append: "⚠️ " | append: warnings_data.slug_duplicate[lang] | append: " " %}
      {%- else %}
        {%- if current_item_slug != '' %}{% assign seen_slugs = seen_slugs | push: current_item_slug %}{% endif -%}
      {%- endif %}

      {% include taxonomy-list-block.html
        item=item
        base_path="/" | append: lang | append: "/" | append: type
        counts=counts
        ui=ui
        warning=current_item_warning
        lang=lang
        render_type='html'
      %}
    {%- endfor %}
  </ul>
</section>
